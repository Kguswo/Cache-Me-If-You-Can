# 7. TCP 혼잡 제어

네트워크 계층이 혼잡에 대해 어떠한 피드백도 제공하지 않기 때문에 TCP는 종단 간의 혼잡 제어를 사용함

## 7.1 전통적인 TCP의 혼잡 제어
네트워크 혼잡에 따라 송신자가 보내는 데이터의 양을 제한

- 3가지 의문: 전송률 계산 방법, 경로 혼잡 감지 방법, 송신율 제한을 위한 알고리즘

### 전송률 계산 방법
- 혼잡 윈도(congestion window): 송신자가 네트워크로 트래픽을 전송하는 속도를 제한
- 수식 확인 안 된 데이터의 양은 혼잡윈도와 수신윈도를 초과할 수 없음
- 매 왕복주기마다 혼잡윈도(cwnd)만큼 전송 가능
- `속도 = 거리 / 시간` 이므로, 대략 `전송속도 = cwnd / RTT` 라고 볼 수 있다.

### 혼잡 감지 방법
- ACK을 혼잡 윈도 크기 증가를 유발하는 트리거(또는 클록)로 사용하므로 자체 클로킹(self-clocking)이라고 함
- ACK가 느리게 도착할수록 혼잡이 있는 상태이기때문에 ACK 도착에 맞춰 혼잡윈도를 늘려감
- 손실된 세그먼트 = 혼잡
  - 타임아웃이나 중복된 ACK 발생 시 혼잡윈도를 줄여야 함
- 새로운 ACK는 세그먼트가 정상적으로 전달 중이라는 의미: 혼잡윈도 증가
- 대역폭 탐색: 세그먼트 손실 이벤트에 따라 전송률을 줄인 후 정상 ACK도착에 따라 전송률 증가라면, 그 사이에서도 최선의 전송률을 찾기위한 대역폭 탐색이 계속됨

### 전송률 결정 알고리즘
가법적 증가, 승법적 감소(AIMD) 혼잡 제어 형식 - 더하면서 증가시키고, 나누면서 감소
![](https://img1.daumcdn.net/thumb/R1280x0/?scode=mtistory2&fname=https%3A%2F%2Fblog.kakaocdn.net%2Fdn%2FbA8QwK%2FbtrIwHKUyEi%2FVwNvfDwGpjc85L0k4lMDOK%2Fimg.png)

#### 슬로 스타트
- cwnd = 세그먼트 1개 길이로 초기화
- 새로운 ACK : cwnd를 세그먼트 1개 길이만큼 증가
- 타임아웃
  - 슬로 스타트 임계값 = 타임아웃 당시의 cwnd/2 크기로 설정
  - cwnd = 세그먼트 1개 길이로 초기화
- cwnd >= 슬로 스타트 임계값: 혼잡 회피 모드
- 중복 ACK 3개 이상: 빠른 회복 모드로 가면 '리노', 타임아웃 처럼 슬로스타트로 가면 '타호'
  - 빠른 회복 모드
  - 슬로 스타트 임계값 = 타임아웃 당시의 cwnd/2 크기로 설정
  - cwnd = 슬로 스타트 임계값에 세그먼트 3개 크기 더한 값

#### 혼잡 회피
- 새로운 ACK : cwnd 대비 세그먼트 1개 크기의 비율의 세그먼트 일부만큼 크기 혼잡윈도 증가
- 타임아웃
  - 슬로 스타트 임계값 = 타임아웃 당시의 cwnd/2 크기로 설정
  - cwnd = 세그먼트 1개 길이로 초기화
- 중복 ACK 3개 이상: 빠른 회복 모드

#### 빠른 회복
- 중복 ACK : cwnd를 세그먼트 1개 길이만큼 증가
- 새로운 ACK
  - 혼잡 회피 모드
  - cwnd = 슬로 스타트 임계값으로 설정
- 타임아웃
  - 슬로 스타트 임계값 = 타임아웃 당시의 cwnd/2 크기로 설정
  - cwnd = 세그먼트 1개 길이로 초기화

#### TCP 큐빅
- 손실이 마지막으로 발생한 cwnd 크기를 W로 저장
- 가법적 증가 시 W에 다시 도달하는 시점을 K라고 가정
- 현재 시각 t와 K 시점 사이 거리의 세제곱 함수로 cwnd 증가
- W에 가까워지면 속도를 대폭 줄이고, K를 조금 초과할 때까지 조심스럽게 탐지
- t가 K보다 많이 초과하면 새 작동 지점을 찾기 위해 다시 빠르게 증가

### TCP 리노 처리율의 거시적 설명

## 7.2 네트워크 지원 명시적 혼잡 알림과 지연 기반 혼잡 제어
최근에는 네트워크가 혼잡 신호를 보낼 수 있도록 IP 및 TCP에 대한 확장이 배포됨
또한, 측정된 패킷 지연을 통해 혼잡을 추론하는 프로토콜도 변형됨

### 명시적 혼잡 알림(ECN: Explicit Congestion Notification)
1. 혼잡해진 라우터에서 IP 헤더에 ECN 비트를 설정한다.
2. 수신 호스트가 ECN 혼잡 알림 표시를 수신하면 TCP ACK 세그먼트의 ECE(ECN Echo) 필드에 표시하여 전송한다.
3. 송신 호스트가 ECE 혼잡 표시를 수신하면, 혼잡 윈도를 반으로 줄이고 TCP 헤더 CWR(Congestion Window Reduced) 비트를 1로 설정

### 지연 기반 혼잡 제어
- 확인 응답된 모든 패킷에 대해 RTT를 측정, 최소 지연시 RTT(min)
- 혼잡하지 않을 때 처리율: cwnd/RTT(min)
- 위 처리율에 가까울수록 혼잡도가 낮고, 현저히 낮을수록 혼잡한 상태 -> 속도 낮춤

## 7.3 공평성
- 하나의 병목링크를 여러 TCP 연결이 사용할 때, 혼잡 제어에 의해 각 전송률이 제한 받는다.
- 따라서 혼잡제어의 영향을 원하지 않는 애플리케이션은 UDP를 사용
- UDP를 사용하는 애플리케이션이 병목 링크 사용량을 늘리면 TCP는 밀려난다.
- 다중 병렬 TCP 연결도 전송률의 불공평을 야기한다.