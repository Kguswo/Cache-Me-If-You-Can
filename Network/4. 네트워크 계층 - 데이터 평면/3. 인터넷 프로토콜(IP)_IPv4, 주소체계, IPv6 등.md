# 3. 인터넷 프로토콜(IP): IPv4, 주소체계, IPv6 등

## 3.1 IPv4 데이터그램 포맷
![](https://velog.velcdn.com/images/wxxhyeong/post/0f255cea-0177-40a5-a815-d45272f06a51/image.png)

- 버전번호: IP 프로토콜의 버전(4비트)
- 헤더 길이: IP 데이터그램에서 실제 페이로드가 시작되는 위치 결정(기본값 20바이트)
- 서비스 타입: IP 데이터그램의 유형(실시간/비실시간 구분, 명시적 혼잡 알림 등)
- 데이터그램 길이(16비트): 이론상 최대 길이 - 65,535바이트, 실제로 대부분은 1,500바이트를 넘지 않음
- 식별자, 플래그, 단편화 오프셋: IP 단편화와 관련됨, IPv6에서는 단편화를 제공하지 않음
- TTL(time-to-live): 패킷의 유효기간, 라우터가 데이터그램을 처리할 때마다 감소, 0이면 패킷 폐기
- 프로토콜: 상위 프로토콜 명시: 6 - TCP, 17 - UDP
- 헤더 체크섬: IP 데이터그램의 오류를 탐지, 오류 검출 시 폐기, 각 라우터마다 재계산 및 저장
- 출발지/목적지 IP
- 옵션: IP 헤더 확장, 거의 사용안됨
- 데이터(페이로드): 상위 계층의 세그먼트 또는 ICMP 등

## 3.2 IPv4 주소체계
일반적으로 호스트는 네트워크와 연결되는 링크를 가짐. 이때, 호스트와 링크 사이의 경계를 `인터페이스`라고 함.  
라우터는 패킷을 받아 적절한 링크로 전달하기 위해 최소 2개 이상의 링크와 연결됨.  
이때, 라우터와 링크 사이의 경계도 `인터페이스`라고 하며, 하나의 라우터는 여러개의 인터페이스를 가짐.
IP주소는 각 호스트나 라우터가 가진 인터페이스의 주소라고 볼 수 있다.

- 점(.)으로 구분하는 십진 표기법
ex) 193.32.216.9 = 11000001 00100000 11011000 00001001

- 서브넷: 하나의 라우터 인터페이스에 연결된 네트워크를 구분
- 서브넷 마스크: IP 주소체계에서 서브넷에 할당하는 비트 길이를 표현 (ex: 233.1.1.0/24 에서 /24) 
- CIDR(Classes InterDomain Routing): 서브넷 주소체계 표기를 일반화(a.b.c.d/x)
  - prefix: x, IP주소의 네트워크 부분을 구성, 한 기관 내의 장비들은 공통 프리픽스를 공유
  - 32-x: 같은 네트워크 내의 모든 장비를 구분
  - CIDR이 채택되기 전에는 네트워크 부분을 8(A), 16(B), 24(C)비트로 제한 -> 클래스 주소체계(classful addressing): 고유한 IP 주소를 할당하기에 비효율
- 브로드캐스트 주소: 호스트 주소 부분의 비트를 모두 1로 하면 브로드캐스트

### 주소 블록 획득
- 일반 호스트: 주소를 제공하는 ISP와 접촉하여 주소블록 할당받음, 해당 주소블록에서 범위를 나누어 내부 서브넷 사용 가능: ex) 200.23.16.0/20
- ISP, 조직 등: 최상위 국제 기관 ICANN(Internet Corporation for Assigned Names and Numbers)
  - ICANN: IP주소 할당, DNS 루트 서버 관리 등 역할

### 호스트 주소 획득: 동적 호스트 구성 프로토콜
호스트에 IP주소를 할당하는 것은 수동으로도 가능하지만 일반적으로는 **동적 호스트 구성 프로토콜**(Dynamic Host Configuration Protocal, DHCP)사용  
자동으로 호스트와 연결해주는 특성으로 플러그 앤 플레이(plug-and-play protocal) 또는 제로 구성 프로토콜(zero-configuration protocal)이라고도 함.

- 호스트 IP주소 할당
- 서브넷 마스크 제공
- 첫번째 홉 라우터 주소(게이트웨이) 제공
- 로컬 DNS 서버 주소 제공
- 해당 네트워크 내에 DHCP 서버가 없는 경우, DHCP 서버주소를 알려줄 연결 라우터가 필요

#### 주소 할당 과정
1. DHCP 서버 발견: 클라이언트가 67번 포트로 브로드캐스트 UDP 패킷(DHCP 발견 메시지)을 보냄, 출발지는 0.0.0.0, 68번 포트
2. DHCP 서버 제공: 발견 메시지를 받은 DHCP 서버가 DHCP 제공 메시지로 응답, 68번 포트 브로드캐스트
   - 발견 메시지의 트랜잭션 ID
   - 제공된 IP 주소
   - 네트워크 마스크
   - IP 주소 임대 기간
3. DHCP 요청: 제공 메시지를 받은 클라이언트가 DHCP 요청 메시지 전송, 67번 포트 브로드캐스트
4. DHCP ACK: 서버는 요청 메시지에 대해 ACK 메시지로 응답, 68번 포트 브로드캐스트

>새로운 IP주소를 DHCP로부터 얻기 때문에 이동식 기기가 서브넷 사이를 이동할 때 TCP 연결이 유지될 수 없다.
>7장에서 이 TCP연결을 유지하는 방법에 대해 배울 것

## 3.3 네트워크 주소 변환(NAT)

![](https://velog.velcdn.com/images/yujeongkwon/post/51d98c9e-8b00-4d4b-8ac7-dcf6986b423f/image.png)

주소의 할당량 부족으로 인해 네트워크 주소 변환(network address translation, NAT) 사용

- 내부 네트워크에서 하나의 IP주소를 할당받아 NAT 라우터가 사용
- NAT 변환 테이블에 해당 라우터 건너에 연결된 호스트들의 IP주소, 포트번호를 NAT 라우터의 IP주소와 특정 포트번호에 매핑 엔드리 추가
- NAT 라우터를 보는 외부 입장에서 각 포트가 내부적으로는 각 호스트를 의미하게 됨
- 패킷이 NAT 라우터를 거칠 때 출발지 또는 목적지를 NAT 변환 테이블에 의해 변환
- 홈 네트워크에서 실행되는 서버를 운영하기 어렵다는 단점(해결책: NAT 순회)

## 3.4 IPv6
IPv4 프로토콜의 주소공간 부족 현상으로 제안됨.

### IPv6 데이터그램 포맷

![](https://blog.kakaocdn.net/dn/cOsK9e/btsBqgsZiok/xd2l1tTbf4ZoRzNuMmMEkK/img.png)

- 확장된 주소 기능
  - 128비트
  - 애니캐스트 주소 도입: '네트워크적으로 가장 가까운' 하나에게만 데이터를 전송
- 간소화된 40바이트 헤더: 고정길이 헤더를 통해 처리 속도 향상
- 흐름 레이블링: 오디오/비디오 전송은 흐름, 파일/전자메일 전송은 흐름 아님
--- 
- 버전: IP 프로토콜 버전(4비트)
- 트래픽 클래스: 애플리케이션 계층 데이터그램 종류(8비트)
- 흐름 레이블: 데이터그램의 흐름 인식(20비트)
- 페이로드 길이: 16비트, 부호 없는 정수
- 다음 헤더: 상위 계층 프로토콜
- 홉 제한: 데이터그램의 이동 제한, 0보다 작아지면 데이터그램 삭제
- 출발지와 목적지 주소
- 데이터: 페이로드 부분

#### IPv4와 비교해 없어진 것
- 단편화/재결합: 데이터그램이 너무 커서 출력 링크로 전달 불가시 ICMP 메시지(Packet Too Big) 전송, IP전달 속도 향상
- 헤더 체크섬: 트랜스포트 계층의 체크섬만으로 충분하다고 판단, 라우터마다 수행되던 체크섬 삭제로 속도 향상
- 옵션: 필요하다면 다음 헤더 중 하나로 설정 가능

### IPv4에서 IPv6로의 전환
IPv6을 다루는 라우터는 IPv4도 다룰 수 있지만, IPv4용 라우터는 IPv6를 인식하지 못함

#### 터널링
두 노드 IPv6 사이에 IPv4 전용 라우터를 지나야 할때 해당 구간을 터널이라고 함

- IPv6 패킷을 IPv4 패킷의 페이로드로 캡슐화 하고, IPv4의 출발지와 도착지를 수정하여 터널링
![](https://velog.velcdn.com/images/yujeongkwon/post/5243f18a-df25-4acd-88cb-187467419483/image.png)