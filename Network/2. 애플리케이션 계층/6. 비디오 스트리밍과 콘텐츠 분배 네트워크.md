# 6. 비디오 스트리밍과 콘텐츠 분배 네트워크

## 6.1 인터넷 비디오
- 스트리밍 비디오 애플리케이션은 녹화된 비디오를 서버에 저장하고 사용자가 요청 시 전달
- 비디오는 일반적으로 초당 24 또는 30 개의 이미지가 일정한 속도로 표시
- 이미지는 픽셀 단위로 구성 -> 각 픽셀은 휘도와 색상을 나타내는 여러 비트로 표시
- 비디오는 압축 가능
  - 높은 압축: 낮은 비트 전송률 = 낮은 품질
  - 낮은 압축: 높은 비트 전송률 = 높은 품질

#### 스트리밍 비디오에서 가장 중요한 성능 척도: 평균 종단 간 처리량
  - 압축된 비디오의 전송률 이상의 평균 처리량을 제공해야 함
  - ex) 4K 스트리밍: 10Mbps 이상의 비트 전송률
  - 사용자는 사용 가능한 대역폭을 확인하고 비디오 버전을 선택 가능

## 6.2 HTTP 스트리밍 및 DASH
- HTTP GET 요청을 통해 클라이언트 측 애플리케이션 버퍼에 전송된 바이트 저장되고, 버퍼의 바이트가 정해진 임계값(threshold)를 초과하면 재생 시작  
- 버퍼에서 주기적으로 비디오 프레임을 가져와 압축 해제 후 사용자 화면에 표시

>문제점: 모든 클라이언트가 대역폭 차이에도 불구하고 같은 버전의 비디오 수신

### HTTP 기반 스트리밍 DASH
- 여러가지 버전(비트율, 품질)으로 인코딩 된 비디오
- 비디오의 각 버전은 서로 다른 URL로 저장 -> 각 버전의 URL을 제공하는 매니페스트 파일(manifest file)을 클라이언트에 제공
- 클라이언트는 몇 초 분량의 비디오 조각(chunk) 요청 -> 가용 대역폭 상황에 따라 매번 버전 선택
- HTTP GET 요청 메시지에 URL과 byte-range 지정

## 6.3 콘텐츠 분배 네트워크(CDN)

- 단일 거대 데이터 센터 운영의 문제점
  - 특정 클라이언트와의 원거리
  - 인기 있는 비디오의 같은 통신 링크로의 반복 전송 -> 중복 비용
  - 장애로 인한 전체 서비스 중단

>문제를 해결하기 위해 콘텐츠 분배 네트워크(Content Distribution Network, CDN) 이용

1. 다수의 지점에 분산 서버 운영
2. 클라이언트를 최적 지점의 CDN 서버와 연결
3. 사설 CDN 또는 제 3자가 운영하는 CDN 사용 가능

#### 서버 위치에 대한 철학 2가지 (택1)
- Enter Deep
  - 더 깊숙이 많이 구축, 사용자와 CDN 서버 사이의 링크 및 라우터 수 최소화
  - 지연 시간 및 처리율 개선
  - 단점: 서버 클러스터 유지 관리 비용 증가
- Bring Home
  - 적은 수의 핵심 지점에 큰 규모로 서버 클러스터 구축
  - 클러스터를 인터넷 교환 지점(IXP)에 배치
  - 클러스터 유지 및 관리 비용 감소
  - 단점: 지연 시간 증가, 처리율 감소

>특정 지역에서 인기있는 비디오 복사본만 유지하도록 하기 위해 풀(pull) 방식 사용

#### 구글의 네트워크 인프라 스트럭처
세 계층의 서버 클러스터로 구성
1. 메가 데이터 센터 (19개)
    - 수십만 개의 서버
    - 검색 결과, 지메일 메시지 등 동적이고 개인화된 콘텐츠 서비스 제공
2. IXP 클러스터 (약 90개)   
    - 수백 개의 서버
    - 유튜브 비디오 등 정적 콘텐츠 서비스 제공
3. enter-deep 클러스터 (수백개)
    - 수십개의 단일 랙 서버
    - TCP 분할 및 검색 결과를 담은 웹페이지 등 정적 콘텐츠 서비스 제공

- 검색 질의
  - enter-deep 에서 정적 콘텐츠 반환
  - 메가 데이터 센터에서 개인화된 검색 결과 반환
- 유튜브 비디오
  - IXP 클러스터에서 비디오 제공
  - 관련 웹페이지는 enter-deep 에서 제공
  - 비디오 관련 광고는 메가 데이터 센터에서 제공

### CDN 동작
>사용자 호스트 웹 브라우저가 비디오 URL 지정  
-> 요청 URL의 도메인 네임에 대해 DNS 질의  
-> 로컬 DNS가 해당 질의를 애플리케이션 책임 DNS로 전달  
-> 책임 DNS는 URL IP주소 대신 해당 비디오를 담당하는 책임 CDN 서버를 알려줌  
-> 책임 CDN 서버가 콘텐츠를 줄 CDN 서버의 IP 주소를 로컬 DNS 서버에 전달  
-> 클라이언트는 해당 IP 주소로 직접 TCP 연결하여 HTTP GET 요청 전송

### 클러스터 선택 정책
클라이언트를 어떤 서버 클러스터 또는 CDN 데이터 센터로 연결할 것인가? 2가지 기법
1. 로컬 DNS IP 주소에 기반하여 지리적으로 가장 가까운 클러스터 할당
    - 문제1: 일부 클라이언트에는 네트워크 경로의 길이에 따라 가장 가까운 클러스터가 아닐 수 있음
    - 문제2: 로컬 DNS가 클라이언트에게서 멀리 있는 경우 CDN도 멀게 할당될 수 있음
2. 실시간 측정(real-time measurements)에 따른 선택
    - ping이나 DNS 질의 같은 프로브 메시지를 통해 클러스터와 클라이언트 간 지연 및 손실 성능 판단
    - 문제: 많은 로컬 DNS가 이와 같은 메시지에 응답하지 않음

## 6.4 사례연구: 넷플릭스, 유튜브

### 넷플릭스
#### 2가지 구성요소의 역할
- 아마존 클라우드
  - 웹사이트(사용자 관리, 결제, 영화 검색, 추천 등 백엔드, DB)
  - 콘텐츠 수집
  - 콘텐츠 처리(비디어 버전 생성)
  - CDN으로의 버전 업로드(트래픽이 적은 시간에 CDN에 푸시 배포 - 주로 사용)
- CDN(제 3자 + 자체)
  - 비디오 스트리밍
  - 풀 캐싱(pull-caching) 사용
  - ISP에 위치한 CDN 서버에 원하는 파일이 있으면 우선 선택, 없다면 IXP 서버 선택

#### 스트리밍 방식
- 결정된 CDN 서버와 독점 버전의 DASH를 이용해 상호작용

### 유튜브
#### 자체 비공개 CDN
- 클라이언트와 클러스터 간의 RTT(Round Trip Time, 왕복시간)가 가장 적은 CDN 서버 선택
- 균형있는 작업 부하를 위해 선택되는 CDN을 조절하기도 함

#### 스트리밍 방식
- DASH와 같은 적응적 스트리밍 대신 사용자가 스스로 버전 선택
- 재생 위치 조정, 조기 종료로 인한 대역폭/서버 자원 낭비 방지를 위해 선인출 데이터 이후 추가로 전송되는 데이터 흐름을 제한
- 사용자로부터 서버로의 비디오 업로드에도 HTTP 스트리밍을 사용함(여러 버전으로 처리하여 저장)