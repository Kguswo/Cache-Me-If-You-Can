# 5. P2P 파일 분배

- P2P 구조는 항상 켜져있는 인프라스트럭처 서버에 최소한으로 의존
- 호스트 쌍(피어)이 서로 직접 통신
- 피어(Peer): 사용자의 데스크톱, 랩톱, 스마트폰이 소유
- 각 피어는 재분배 역할 수행: 수신한 파일의 일부를 다른 피어들에게 재분배하여 프로세스를 도움
- 대표적 프로토콜: 비트토렌트

### P2P 구조의 확장성
#### 사례 분석
> 한 파일을 고정된 수의 피어에게 분배하는 양적 모델
> - 서버의 업로드 속도: u(s)
> - i번째 피어의 업로드 속도: u(i)
> - i번째 피어의 다운로드 속도: d(i)
> - 파일의 크기: F 비트
> - 피어의 수: N
> - 분배 시간(distribution time): 모든 피어가 파일의 복사본을 얻는 데 걸리는 시간
> - 인터넷 코어는 충분한 대역폭을 갖고 있다고 가정

<img width="672" alt="image" src="https://github.com/user-attachments/assets/dd0f3cbd-4612-4062-9fde-dc030d65bfb8" />

1. 클라이언트 - 서버 구조
   - 서버가 파일 복사본을 N개의 피어에 각각 전송: `NF` 비트
   - 서버의 업로드 속도에 의해 분배 시간은 최소 `NF/u(s)` 
   - 가장 느린 피어의 다운로드 속도: `d(min) = min{d(1), d(2), ... , d(N)}` -> 각 피어의 분배 시간 최소 `F/d(min)`
   - 즉, 최종 분배 시간의 근사치는 `max{NF/u(s), F/d(min)}`
   - 피어의 수 N에 따라 선형적 증가

2. P2P 구조
   - 서버가 파일 복사본을 접속링크에 최소 한번 업로드: `F/u(s)`
   - 가장 느린 피어의 다운로드 속도: `d(min) = min{d(1), d(2), ... , d(N)}` -> 분배 시간 최소 `F/d(min)`
   - 파일 전달 속도는 `서버 + 모든 피어`를 사용해 파일을 전달하는 것보다 빠를 수 없음: `NF/{u(s) + u(1) + ... + u(N)}`
   - 즉, 최종 분배 시간의 근사치는 `max{F/u(s), F/d(min), NF/{u(s) + u(1) + ... + u(N)}}`

#### 그래프 조건
>- 서버 전송률 = 피어 업로드 속도 * 10
>- 모든 피어가 같은 업로드 속도
>- 파일은 최대 1시간 안에 전달 가능
>- 다운로드 속도가 충분히 빠름

<img width="725" alt="image" src="https://github.com/user-attachments/assets/4cce9e77-88a4-45fe-a037-61878dcfec54" />

#### 결론
- P2P 구조를 가진 애플리케이션은 자가 확장성을 가짐
- 피어가 비트의 소비자이자 재분배자이기 때문

### 비트토렌트
- 파일 분배를 위한 P2P 프로토콜
- 파일 분배에 참여하는 피어의 모임을 토렌트(torrent)라고 함
- 피어들은 서로 같은 크기의 `청크(chunk) - 256KB` 를 다운로드
- 청크를 다운로드하면서 다른 청크에게 업로드 함

#### 동작원리

<img width="794" alt="image" src="https://github.com/user-attachments/assets/10bc9146-3c02-4170-b474-0a9e06eed5ba" />

- 각 토렌트는 트래커(인프라스트럭처 노드)를 가짐
  - 트래커의 피어 추적: 피어는 토렌트 가입 시 트래커에 자신을 등록하고, 주기적으로 존재를 알림
- 트래커는 가입한 피어(홍길동)에게 다른 피어들의 IP 주소(임의 부분집합)를 전송
- 홍길동은 받은 피어 목록을 통해 TCP 연결 설정
- 연결된 피어는 시간에 따라 변동, 각 피어는 서로 다른 파일 청크의 일부를 갖고 있음
- 홍길동은 연결된 피어들(L개)에 청크 목록 요구 -> 이를 바탕으로 필요한 청크 요구
- 어느 청크를 요청?
  - 가장 드문 것(rarest first): 청크 목록에서 가장 드문 것 -> 더 빨리 재분배되므로 각 청크 복사본 수 대략 동일
- 누구에게 재분배?
  - 현명한 교역(trading): 가장 빠르게 데이터를 제공하는 4개의 피어에 보답(활성화: unchoked)
  - 10초마다 속도 재계산 -> 활성화 피어 수정
  - 30초마다 임의의 피어 추가 -> 낙관적으로 활성화(optimistically unchoked)
  - 홍길동으로부터 청크를 받지 못하는 피어는 비활성화(choked) 상태
  - 비슷한 속도로 업로드할 능력이 있는 피어들이 서로를 찾으려는 경향
  - 임의의 피어 선택을 통해 새로운 피어도 청크를 얻게 하여 교역 참여자 증가

>비트토렌트의 기타 기법: 조각, 파이프라이닝, 무작위 우선 선택 등

#### 비트토렌트의 보상 방식: TFT(tit-for-tat)
  - 회피가 가능하지만, 피어들의 능동적인 파일 공유 유도
