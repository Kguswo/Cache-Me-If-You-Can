# 4. DNS: 인터넷의 디렉터리 서비스

### 인터넷 호스트 식별자
- 호스트 이름(hostname) : 사람이 알기 쉬운 이름 (ex: www.google.com)
- IP 주소 (IP address) : 라우터가 처리하기 좋은 이름 (ex: 121.7.106.83)
  - 4byte: 각 바이트는 1 ~ 255까지 십진수로 표현하며 점(.)으로 구분
  - 계층구조: 왼쪽에서 오른쪽으로 조사함에 따라 위치 판별 가능

## 4.1 DNS가 제공하는 서비스
사람과 라우터의 선호 식별자 차이 해결 필요 -> 디렉터리 서비스  

### DNS(Domain Name System)
#### 주요 기능
호스트 이름을 IP 주소로 변환  
#### 추가 기능
- 호스트 에일리어싱(host aliasing)
  - 별칭 호스트 이름을 통해 정식 호스트 이름을 얻기 위함 (ex: some.com -> relay1.west-coast.some.com)  
- 메일 서버 에일리어싱(mail server aliasing)
  - MX 레코드를 통해 웹 서버와 동일한 별칭을 통해 메일서버를 구분할 수 있음  
- 부하 분산(load distribution)
  - 하나의 정식 호스트 이름에 해당하는 IP 주소 집합 관리, 순환식 응답을 통한 트래픽 분산 효과  

#### 특징
- 계층구조의 분산 데이터베이스
- 애플리케이션 계층 프로토콜 (사용자가 직접 상호작용하는 애플리케이션은 아님)
- BIND 소프트웨어를 수행하는 유닉스 컴퓨터
- UDP 사용, 포트번호 53

## 4.2 DNS 동작 원리 개요

#### IP 주소 변환 과정
[애플리케이션] 호스트 이름으로 DNS 클라이언트 호출 -> 네트워크에 질의 (포트 53을 통해 UDP 데이터그램 전송) -> `(블랙박스)` -> DNS 응답 수신 (IP 주소)

#### 단일 인터넷 네임서버의 문제점: 확장성 X
1. 서버 고장 시 전체 인터넷 중단
2. 대량 트래픽
3. 요청 호스트와의 거리
4. 유지 관리(대량의 데이터베이스, 갱신 이슈, 인증 문제)

#### 분산 계층 데이터베이스
[pdf 157p figure 2.17]

- 간략한 DNS 동작 과정
>루트 서버 중 하나에 접속 -> 루트 서버가 최상위 레벨 도메인 서버의 IP 주소 반환 -> 최상위 레벨 도메인 서버에 접속 -> 책임 서버 IP 반환 -> 책임 서버 접속 -> 호스트 IP 반환

- 루트 DNS 서버
  - 전세계 13개의 루트서버, 1000개 이상의 루트 서버 인스턴스
  - 최상위 레벨 도메인(TLD) 서버 IP 주소 제공
- 최상위 레벨 도메인(TLD) 서버
  - com, org, net, edu, gov 등의 상위 레벨 도메인, kr, uk, fr 등의 국가 상위 레벨 도메인 서버
  - 책임 DNS 서버에 대한 IP 주소 제공
  - 책임 DNS 서버를 알고 있는 중간 DNS 서버만 제공할 수도 있음
- 책임 DNS 서버
  - 각 기관이 제공한 DNS 레코드 보관(기관이 저장 비용 지불)
  - 기관이 직접 책임 DNS 서버를 구현 가능
  - 호스트 IP 주소 제공
- 로컬 DNS 서버 (계층구조에 포함 안됨)
  - 각 ISP가 갖는 DNS 서버
  - 프록시로 동작
  - 호스트가 질의한 IP 주소가 저장되어 있다면 바로 반환, 없다면 DNS 서버 계층으로 질의 전달

[pdf 159p figure 2.19]
>재귀적 질의 - 자신을 대신하여 필요한 매핑을 얻으려고 하는 것: 호스트 -> 로컬 DNS 서버
반복적 질의 - 알고자 하는 응답이 직접 돌아오는 질의: 로컬 DNS 서버 -> DNS 서버 계층 (일반적)

### DNS 캐싱
- 로컬 DNS는 DNS 서버 계층에서 받은 IP 정보를 로컬 메모리에 저장할 수 있음
- 만료 기간(보통 2일) 이후 삭제

## 4.3 DNS 레코드와 메시지
#### 자원 레코드(RR: Resource Record)란?
- DNS 서버가 호스트 이름을 IP 주소로 매핑하기 위한 정보
- 4개의 튜플로 구성: Name, Value, Type, TTL(Time To Live)
    | Type | Name | Value |
    |---|---|---|
    | A | 호스트 이름 | IP 주소 |
    | NS | 도메인 | 책임 DNS 서버 호스트 이름 |
    | CNAME | 별칭 호스트 이름 | 정식 호스트 이름 |
    | MX | 별칭 호스트 이름 | 메일 서버 정식 이름 |
- NS 레코드가 있다면, 해당 책임 DNS 서버의 IP 주소를 제공하는 A 레코드도 함께 존재함

### DNS 메시지
질의와 응답 메시지 모두 같은 포맷

[pdf 163p figure 2.21]

#### 1. 헤더 영역 (header section) - 12byte  
1. 식별자(Identification) : 질의와 응답 간의 관계 식별, 질의에서 응답으로 복사 - 16bit
2. 플래그 필드
    - 질의/응답 플래그: 질의(0), 응답(1)
    - 책임 플래그: 질의 이름에 대한 책임 서버일 때 응답에 표시
    - 재귀 요구 플래그: 재귀적 질의 요청 표시
    - 재귀 가능 플래그: DNS 서버가 재귀 질의를 지원할 때 응답에 설정
3. 개수 필드 : 데이터 영역의 4가지 타입의 발생 횟수

#### 2. 질문 영역 (question section)
- 질의에 대한 정보
- 이름 필드, 타입 필드(A, MX 등)
#### 3. 답변 영역 (answer section)
- 질의된 이름에 대한 자원 레코드()
- Name, Value, Type, TTL
- 여러 개의 RR 포함 가능, IP 주소가 여러 개일 수 있어서
#### 4. 책임 영역 (authority section)
다른 책임 서버의 레코드 포함
#### 5. 추가 영역 (additional section)
- 다른 도움이 되는 레코드
- ex) MX 질의에 대한 응답이 답변 영역에 있다면, 해당 IP주소에 대한 Type A 레코드 포함

>nslookup 프로그램을 사용해 확인 가능

### DNS 데이터베이스에 레코드 삽입
>등록기관은 상업기관이며, ICANN(Internet Corporation for Assigned Names and Numbers)가 등록기관을 승인

1. 등록할 도메인 네임의 주책임 서버와 부책임 서버의 이름과 IP 주소를 등록기관 (registrar)에 제공 - 유료
2. 등록기관은 두 책임 서버에 대한 Type NS와 Type A 레코드를 TLD 서버에 등록
3. 등록한 책임 서버에 웹 서버에 대한 Type A 레코드와 메일 서버에 대한 Type MX 레코드를 등록해야만 함

#### DNS 취약점 - 보안 초점
>2002년 10월에 발생한 루트 DNS 서버에 대한 DDoS 대역폭 플러딩 : 피해 최소
>- 많은 루트 서버가 ICMP 핑 메시지 블록(패킷 필터)
>- 대부분의 로컬 DNS가 TLD 서버 IP 주소를 캐싱하고 있었음

>2016년 10월에 발생한 TLD 서버에 대한 DDoE 공격 : 피해 큼
>- 루트 서버 공격때만큼 우회 불가능

>중간자 공격(man-in-the-middle attack)  
>- DNS 서버로 가짜 응답 전송 -> 가짜 레코드 등록  
>- 개선을 위해 DNS 보안 확장(DNSSEC) 프로토콜 개발, 인터넷에서 일반화